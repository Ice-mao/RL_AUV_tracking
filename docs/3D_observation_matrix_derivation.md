# 3D球坐标观测矩阵H的数学推导

## 1. 问题设定

### 状态向量 (6维)
```
x = [x, y, z, vx, vy, vz]^T
```
- 位置：(x, y, z)
- 速度：(vx, vy, vz)

### 观测向量 (3维球坐标)
```
z = [r, θ, γ]^T
```
- r: 径向距离 (range)
- θ: 方位角 (azimuth) - 水平面内的角度，从x轴正方向逆时针测量
- γ: 俯仰角 (elevation) - 相对于水平面的角度，向上为正

## 2. 坐标系统

### 全局坐标系
- 目标位置：p_t = [x_t, y_t, z_t]^T
- 智能体位置：p_a = [x_a, y_a, z_a]^T  
- 相对位置：Δp = p_t - p_a = [Δx, Δy, Δz]^T

### 球坐标系
```
r = √(Δx² + Δy² + Δz²)                    # 总距离
θ = arctan2(Δy, Δx)                       # 方位角
γ = arctan2(Δz, √(Δx² + Δy²))            # 俯仰角
```

其中：
- r_xy = √(Δx² + Δy²) 是水平面内的距离

## 3. 观测函数

```
h(x) = [r(x), θ(x), γ(x)]^T
```

具体表达式：
```
r(x) = √((x-x_a)² + (y-y_a)² + (z-z_a)²)
θ(x) = arctan2(y-y_a, x-x_a)  
γ(x) = arctan2(z-z_a, √((x-x_a)² + (y-y_a)²))
```

## 4. 雅可比矩阵H的推导

观测矩阵H = ∂h/∂x，维度为3×6：

```
H = [∂r/∂x   ∂r/∂y   ∂r/∂z   ∂r/∂vx   ∂r/∂vy   ∂r/∂vz ]
    [∂θ/∂x   ∂θ/∂y   ∂θ/∂z   ∂θ/∂vx   ∂θ/∂vy   ∂θ/∂vz ]
    [∂γ/∂x   ∂γ/∂y   ∂γ/∂z   ∂γ/∂vx   ∂γ/∂vy   ∂γ/∂vz ]
```

### 4.1 距离r的偏导数

```
r = √(Δx² + Δy² + Δz²)
```

对各个位置坐标的偏导数：
```
∂r/∂x = ∂r/∂Δx = Δx/r
∂r/∂y = ∂r/∂Δy = Δy/r  
∂r/∂z = ∂r/∂Δz = Δz/r
```

对速度坐标的偏导数：
```
∂r/∂vx = ∂r/∂vy = ∂r/∂vz = 0
```
(距离观测不直接依赖于速度)

### 4.2 方位角θ的偏导数

```
θ = arctan2(Δy, Δx)
```

使用arctan2的偏导数公式：
```
∂arctan2(v,u)/∂u = -v/(u² + v²)
∂arctan2(v,u)/∂v = u/(u² + v²)
```

得到：
```
∂θ/∂x = ∂θ/∂Δx = -Δy/(Δx² + Δy²) = -Δy/r_xy²
∂θ/∂y = ∂θ/∂Δy = Δx/(Δx² + Δy²) = Δx/r_xy²
∂θ/∂z = 0  (方位角不依赖z坐标)
∂θ/∂vx = ∂θ/∂vy = ∂θ/∂vz = 0
```

### 4.3 俯仰角γ的偏导数

```
γ = arctan2(Δz, r_xy)，其中 r_xy = √(Δx² + Δy²)
```

这是一个复合函数，需要使用链式法则：
```
∂γ/∂x = ∂γ/∂r_xy × ∂r_xy/∂x + ∂γ/∂Δz × ∂Δz/∂x
```

计算各项：
```
∂γ/∂r_xy = -Δz/(r_xy² + Δz²) = -Δz/r²
∂γ/∂Δz = r_xy/(r_xy² + Δz²) = r_xy/r²
∂r_xy/∂x = ∂r_xy/∂Δx = Δx/r_xy
∂Δz/∂x = 0
```

因此：
```
∂γ/∂x = -Δz/r² × Δx/r_xy = -Δx×Δz/(r²×r_xy)
∂γ/∂y = -Δz/r² × Δy/r_xy = -Δy×Δz/(r²×r_xy)
∂γ/∂z = r_xy/r²
∂γ/∂vx = ∂γ/∂vy = ∂γ/∂vz = 0
```

## 5. 最终的观测矩阵H

```
H = [[Δx/r,                     Δy/r,                     Δz/r,        0, 0, 0],
     [-Δy/r_xy²,                Δx/r_xy²,                 0,           0, 0, 0],
     [-Δx×Δz/(r²×r_xy),        -Δy×Δz/(r²×r_xy),         r_xy/r²,     0, 0, 0]]
```

其中：
- Δx = x_target - x_agent
- Δy = y_target - y_agent  
- Δz = z_target - z_agent
- r = √(Δx² + Δy² + Δz²)
- r_xy = √(Δx² + Δy²)

## 6. 实现注意事项

### 6.1 奇点处理
1. **r ≈ 0时：** 目标与智能体重合，所有偏导数趋向于0
2. **r_xy ≈ 0时：** 目标在智能体正上方或正下方，方位角θ未定义

### 6.2 数值稳定性
```python
if r_total < 1e-8:  # 避免除零
    Hmat = np.zeros((3, 6))
else:
    # 计算偏导数
    if r_xy < 1e-8:  # 避免极点奇异性
        dtheta_dx = dtheta_dy = 0
        dgamma_dx = dgamma_dy = 0
    else:
        # 正常计算
```

### 6.3 角度wrap处理
观测误差计算时需要处理角度的周期性：
```python
innov[1] = wrap_around(innov[1])  # wrap azimuth θ
innov[2] = wrap_around(innov[2])  # wrap elevation γ
```

## 7. 与2D情况的对比

### 2D极坐标 (r, α)
```
H_2D = [[Δx/r,     Δy/r,     0, 0],
        [-Δy/r²,   Δx/r²,    0, 0]]
```

### 3D球坐标 (r, θ, γ)  
```
H_3D = [[Δx/r,                     Δy/r,                     Δz/r,        0, 0, 0],
        [-Δy/r_xy²,                Δx/r_xy²,                 0,           0, 0, 0],
        [-Δx×Δz/(r²×r_xy),        -Δy×Δz/(r²×r_xy),         r_xy/r²,     0, 0, 0]]
```

可以看出3D情况是2D的自然扩展，增加了z坐标和俯仰角的影响。
